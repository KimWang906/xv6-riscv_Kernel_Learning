# inode(아이노드)

아이노드는 이름이 지정되지 않은 단일 파일을 나타냅니다.

inode 디스크 구조에는 메타데이터가 포함되어 있습니다.
파일의 유형, 크기, 참조하는 링크 수 및 파일 내용을 포함하는 블록 목록입니다.

 아이노드는 sb.startinode의 디스크에 순차적으로 배치되고.
 각 아이노드는 디스크 상의 위치를 나타내는 숫자를 가지고 있다.

 커널은 사용 중인 inode의 테이블을 메모리에 보관합니다.
 접근을 동기화할 수 있는 장소를 제공하다
 여러 프로세스에서 사용하는 inode로 이동합니다.
 in-memory 아이노드는 디스크에 저장되지 않은 부기 정보를 포함한다: ip->ref 및 ip->valid.

 아이노드와 그 메모리 내 표현은 파일 시스템 코드의 나머지 부분에서 사용될 수 있기 전에 일련의 상태를 거친다.

* Allocation: (디스크에서) 유형이 제로가 아닌 경우 아이노드가 할당됩니다.  
ialloc는 할당하고, 참조 및 링크 수가 0으로 떨어지면 iput은 비워집니다.  
  
* Referencing in table: ip->ref가 0일 경우 inode 표의 항목은 무료입니다.
  그렇지 않으면 ip->ref는 엔트리에 대한 메모리 내 포인터 수(열린 파일 및 현재 디렉터리)를 추적한다.  
  iget은 테이블 항목을 찾거나 만들고 참조를 증가시키며, iput은 참조를 감소시킵니다.  
  
* Valid: 아이노드 테이블 항목의 정보(type, size, &c)는 ip->valid가 1인 경우에만 정확합니다.  
  ilock은 아이노드를 읽습니다.  
 디스크가 ip->valid를 설정하고 iput는 ip->ref가 0으로 떨어지면 ip->valid를 지웁니다.  
  
* Locked: 파일 시스템 코드는 처음 아이노드를 잠근 경우에만 아이노드와 그 내용을 검사하고 수정할 수 있습니다.  
  
따라서 일반적인 코드는 다음과 같습니다.  

```code
 ip = iget(dev, inum)
 ilock(ip)
 ...ip->xxx...를 검사하고 수정합니다.
 i unlock(ip)
 iput(ip)
```

ilocks는 igets와 분리되어 시스템 호출이 아이노드에 대한 장기적인 참조를 얻을 수 있고 짧은 시간 동안만 잠글 수 있습니다. (예: 읽기 파일)  
분리는 또한 경로 이름 조회 중 교착 상태 및 경주를 방지하는 데 도움이 됩니다.  
iget는 ip->ref를 증가시켜 아이노드가 테이블에 남아 있고 포인터가 유효하게 유지되도록 합니다.  
  
많은 내부 파일 시스템 함수는 호출자가 관련된 아이노드를 잠갔다고 예상한다.  
  
itable.lock 스핀 잠금은 테이블 항목의 할당을 보호합니다.  
ip->ref는 항목이 비어 있는지 여부를 나타내고 ip->dev와 ip->inum은 항목이 어떤 i-노드를 보유하는지 나타내므로, 이러한 필드 중 하나를 사용하는 동안 itable.lock을 보유해야 합니다.  
  
ip->잠금 잠금은 ref, dev, inum을 제외한 모든 ip-> 필드를 보호합니다.  
ip->lock은 아이노드의 ip->valid, ip->size, ip->type, &c를 읽거나 쓰려면 ip->lock을 사용해야 합니다.  
